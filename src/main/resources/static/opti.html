<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GCP ë¹„ìš© ìµœì í™”</title>
  <style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        text-align: center;
    }
    input {
        width: 80%;
        padding: 8px;
        margin: 5px;
    }
    button {
        padding: 10px 20px;
        background-color: #007BFF;
        color: white;
        border: none;
        cursor: pointer;
    }
    button:hover {
        background-color: #0056b3;
    }
    #status {
        margin-top: 20px;
        font-weight: bold;
        color: #FF5733;
    }
    #result {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ddd;
        display: none;
        background-color: #f9f9f9;
    }
    #vmList {
        list-style: none;
        padding: 0;
    }
    .vm-item {
        background: #eaf7ff;
        padding: 8px;
        margin: 5px 0;
        border-radius: 5px;
    }
  </style>
  <script>
    async function optimizeCosts() {
        const userId = document.getElementById("userId").value;
        const accessToken = document.getElementById("accessToken").value;
        const statusDiv = document.getElementById("status");
        const resultDiv = document.getElementById("result");
        const vmList = document.getElementById("vmList");

        if (!userId) {
            alert("ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }
        if (!accessToken) {
            alert("Google Access Tokenì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        // ìƒíƒœ í‘œì‹œ
        statusDiv.innerHTML = "ğŸ”„ ìµœì í™” ì‹¤í–‰ ì¤‘...";
        statusDiv.style.color = "#FFA500";
        resultDiv.style.display = "none";
        vmList.innerHTML = "";

        try {
            const response = await fetch(`http://localhost:8080/api/gcp/cost-optimizer/${userId}/optimize`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${accessToken}`  // âœ… OAuth 2.0 í† í° ì¶”ê°€
                }
            });

            const data = await response.json();
            statusDiv.innerHTML = response.ok ? "âœ… ìµœì í™” ì™„ë£Œ!" : "âŒ ìµœì í™” ì‹¤íŒ¨!";
            statusDiv.style.color = response.ok ? "#28a745" : "#dc3545";

            resultDiv.style.display = "block";
            document.getElementById("resultMessage").innerText = data.message || "ê²°ê³¼ ì—†ìŒ";

            // ì¢…ë£Œëœ VM ëª©ë¡ í‘œì‹œ
            if (data.stoppedVMs && data.stoppedVMs.length > 0) {
                data.stoppedVMs.forEach(vm => {
                    const listItem = document.createElement("li");
                    listItem.className = "vm-item";
                    listItem.textContent = `ğŸ’» ${vm} (ì¢…ë£Œë¨)`;
                    vmList.appendChild(listItem);
                });
            } else {
                vmList.innerHTML = "<li class='vm-item'>ğŸš€ ëª¨ë“  VMì´ ì •ìƒì ìœ¼ë¡œ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.</li>";
            }

        } catch (error) {
            console.error("Error:", error);
            statusDiv.innerHTML = "âŒ ìµœì í™” ìš”ì²­ ì‹¤íŒ¨! ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            statusDiv.style.color = "#dc3545";
        }
    }

    // (ì„ íƒ) ìë™ìœ¼ë¡œ OAuth 2.0 Access Token ê°€ì ¸ì˜¤ëŠ” ê¸°ëŠ¥ ì¶”ê°€
    async function getAccessToken() {
        try {
            const response = await fetch("https://accounts.google.com/o/oauth2/token"); // ì‹¤ì œ APIë¡œ ë³€ê²½ í•„ìš”
            const data = await response.json();
            document.getElementById("accessToken").value = data.access_token || "í† í° ìš”ì²­ ì‹¤íŒ¨!";
        } catch (error) {
            alert("Access Tokenì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }
  </script>
</head>
<body>

<h2>GCP ë¹„ìš© ìµœì í™” ì‹¤í–‰</h2>

<label for="userId">ğŸ‘¤ ì‚¬ìš©ì ID:</label>
<input type="text" id="userId" placeholder="user@example.com"><br><br>

<label for="accessToken">ğŸ”‘ Google Access Token:</label>
<input type="text" id="accessToken" placeholder="OAuth 2.0 Access Token">
<button onclick="getAccessToken()">ìë™ ê°€ì ¸ì˜¤ê¸°</button><br><br>

<button onclick="optimizeCosts()">ğŸš€ ìµœì í™” ì‹¤í–‰</button>

<div id="status"></div>

<div id="result">
  <h3>ğŸ“Š ìµœì í™” ê²°ê³¼</h3>
  <p id="resultMessage"></p>
  <ul id="vmList"></ul>
</div>

</body>
</html>